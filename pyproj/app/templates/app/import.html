{% extends "app/base.html" %}

{% block title %}Import Items{% endblock title %}

{% block body %}
<div class="container mt-4">
    <h1>Import Items from CSV</h1>

    {% if errors %}
        <div class="alert alert-danger">
            <h4>Validation Errors:</h4>
            <ul>
                {% for error in errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    {% if validated_items and save %}
        <div class="alert alert-success">
            <h4>Validation Successful!</h4>
            <p>Found {{ stats.total_items }} items to import:</p>
            <ul>
                <li>{{ stats.root_items }} root items</li>
                <li>{{ stats.child_items }} child items</li>
            </ul>
        </div>

        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="csv_data" value="{{ csv_data }}">
            <input type="hidden" name="save" value="true">
            <button type="submit" class="btn btn-success">Save Items</button>
            <a href="{% url 'app:import_items' %}" class="btn btn-secondary">Start Over</a>
        </form>

        <div class="mt-4">
            <h5>Preview of items to be imported:</h5>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Parent</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in validated_items %}
                    <tr>
                        <td>{{ item.id }}</td>
                        <td>{{ item.name }}</td>
                        <td>{{ item.description }}</td>
                        <td>{{ item.parent_id|default:"-" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <form method="post">
            {% csrf_token %}
            <div class="mb-3">
                {{ form.csv_data.label_tag }}
                {{ form.csv_data }}
                {% if form.csv_data.help_text %}
                    <div class="form-text">{{ form.csv_data.help_text }}</div>
                {% endif %}
                {% if form.csv_data.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.csv_data.errors }}
                    </div>
                {% endif %}
            </div>
            <input type="hidden" name="save" value="false">
            <button type="submit" class="btn btn-primary">Check CSV</button>
        </form>

        <div class="mt-4">
            <h5>CSV Format:</h5>
            <p>Expected headers: <code>ID, In, Name, Desc</code></p>
            <p>Example:</p>
            <pre class="bg-light p-3">
ID,In,Name,Desc
1,-root-,Root Item,This is a root item
2,1,Child Item,This is a child of item 1
3,,Another Child,Same parent as previous item
4,-root-,Another Root,Another root level item</pre>
        </div>
    {% endif %}
</div>
{% endblock body %}